"use strict";const WebSocketUrl=window.location.host+"/ws",ProtocolVersion=1;var ws;function webSocketStart(){try{ws=new WebSocket("ws://"+WebSocketUrl)}catch(exception){console.error(exception)}ws&&(ws.onclose=function(evt){console.log("close:\n"+evt.data)},ws.onerror=function(evt){console.log("error:\n"+evt.data)},ws.onmessage=function(evt){console.log("message:\n");try{var jsonObj;parseJsonMsg(JSON.parse(evt.data))}catch(e){console.error("Parsing error:",e)}},ws.onopen=function(evt){console.log("open:\n"+evt.data),ws&&ws.send(genMessage("Init"))})}function parseJsonMsg(data){data.name&&"DiceWars"==data.name&&data.version&&data.version==ProtocolVersion&&data.data&&parseData(data.data)}var currentMap=null;function parseData(data){for(var msg in Array.isArray(data)||(data=[data]),data)for(var d in data[msg])switch(d){case"map":currentMap=data[msg][d],initMap();break;case"players":if(Array.isArray(data[msg][d]))for(var i in data[msg][d])data[msg][d][i].player&&initPlayer(data[msg][d][i].player);break;case"player":initPlayer(data[msg][d]);break;case"state":setState(data[msg][d])}}function genMessage(val){return JSON.stringify({name:"DiceWars",version:ProtocolVersion,request:val})}function webSocketClose(){ws&&(ws.close(),ws=null)}var isLoaded=!1,toLoad=[];function waitLoad(func,_this,args){return!isLoaded&&(toLoad.push({func:func,this:_this,args:args}),!0)}function endLoad(evt){for(isLoaded=!0,evt.target.parentNode.style.display="none",svgDice=evt.target.parentNode.appendChild(evt.target.contentDocument.querySelector("svg").cloneNode(!0)),evt.target.parentNode.removeChild(evt.target);toLoad.length;){var f=toLoad.shift();f.func.apply(f.this,f.args)}}const strokePoints=[[3,4],[4,5],[2,3],[0,5],[1,2],[0,1]];var svgContent=null,svgDice=null,mapContent=null,playerContent=null,infoContent=null;function initMap(){for(var r in initGrid(currentMap.width,currentMap.height),currentMap.regions){var nb=0;currentMap.regions[r].center={x:0,y:0};var regionObj=document.createElementNS("http://www.w3.org/2000/svg","g");regionObj.setAttribute("id","region_"+r),currentMap.regions[r].obj=regionObj=mapContent.querySelector("#map").appendChild(regionObj),regionObj.setAttribute("stroke-opacity","0.1"),regionObj.setAttribute("fill","#AAA");var regionAnim=document.createElementNS("http://www.w3.org/2000/svg","animate");for(var c in currentMap.regions[r].anim=regionAnim,regionAnim.setAttribute("id","anim"),regionAnim.setAttribute("attributeName","fill-opacity"),regionAnim.setAttribute("values","0.7 ; 0 ; 0.7 ; 0 ; 0.7"),regionAnim.setAttribute("keyTimes","0 ; 0.25 ; 0.5 ; 0.75 ; 1"),regionAnim.setAttribute("dur","1.5s"),regionAnim.setAttribute("begin","none"),regionObj.appendChild(regionAnim),currentMap.regions[r]){var cell=currentMap.regions[r][c],cellObj;(cellObj=document.getElementById("cell_"+cell.x+"_"+cell.y))&&((cellObj=regionObj.appendChild(cellObj.parentNode.removeChild(cellObj))).region=parseInt(r)+1,currentMap.regions[r].center.x+=parseInt(cellObj.getAttribute("_x")),currentMap.regions[r].center.y+=parseInt(cellObj.getAttribute("_y")),++nb)}0!=nb&&(currentMap.regions[r].center.x/=nb,currentMap.regions[r].center.y/=nb)}for(var r in currentMap.regions)for(var c in currentMap.regions[r]){var cell=currentMap.regions[r][c],cellObj;if(cellObj=document.getElementById("cell_"+cell.x+"_"+cell.y)){cellObj.parsed=!0;for(var i=0,y=cell.y-1;y<cell.y+2;++y)for(var _x=0;_x<2;++_x){var x=cell.x-1;y==cell.y?x+=2*_x:x+=_x+(y+1)%2;var draw=!1;if(x<0||y<0||x>=currentMap.width||y>=currentMap.height)draw=!0;else{var cellObj2=document.getElementById("cell_"+x+"_"+y);cellObj2&&!cellObj2.parsed&&cellObj2.region!=cellObj.region&&(draw=!0)}if(draw){var line=document.createElementNS("http://www.w3.org/2000/svg","line");line.setAttribute("x1",cellObj.data[strokePoints[i][0]].x),line.setAttribute("y1",cellObj.data[strokePoints[i][0]].y),line.setAttribute("x2",cellObj.data[strokePoints[i][1]].x),line.setAttribute("y2",cellObj.data[strokePoints[i][1]].y),line.setAttribute("stroke","black"),mapContent.querySelector("#map").appendChild(line)}++i}}}}const cellSize={w:30,h:20},gameOffset={x:10,y:30};var gameSize={w:0,h:10};function initGrid(width,height){var content=document.getElementById("content");if(!content)return!1;content.innerHTML="";var svgDiceDiv=document.createElement("div");svgDiceDiv=content.appendChild(svgDiceDiv),(svgDice=document.createElement("object")).onload=endLoad,svgDice.setAttribute("id","svgdice"),svgDice.setAttribute("type","image/svg+xml"),svgDice.setAttribute("data","img/dice.svg"),svgDice.setAttribute("display","none"),svgDice=svgDiceDiv.appendChild(svgDice),(svgContent=document.createElementNS("http://www.w3.org/2000/svg","svg")).setAttribute("width","100%"),svgContent.setAttribute("height","100%"),(mapContent=document.createElementNS("http://www.w3.org/2000/svg","g")).setAttribute("id","mapcontent");var mapNode=document.createElementNS("http://www.w3.org/2000/svg","g");mapNode.setAttribute("id","map"),mapNode.setAttribute("fill","#EEE"),mapNode.setAttribute("stroke","#DDD"),mapContent.appendChild(mapNode);var stateNode=document.createElementNS("http://www.w3.org/2000/svg","g"),offsetx,infoNodeContent;stateNode.setAttribute("id","state"),mapContent.appendChild(stateNode),svgContent.appendChild(mapContent);for(var i=0;i<width;++i)for(var j=0;j<height;++j){offsetx=j%2?gameOffset.x+cellSize.w/2:gameOffset.x;var _x=i*cellSize.w+cellSize.w/2,_y=j*(cellSize.h*(1-(1-Math.sin(Math.PI/6))/2))+cellSize.h/2;mapNode.appendChild(genHexagonSVG(_x+offsetx,_y+gameOffset.y,cellSize.w,cellSize.h,"cell_"+i+"_"+j)),_x+=cellSize.w/2,_y+=cellSize.h/2,gameSize.w<_x&&(gameSize.w=_x),gameSize.h<_y&&(gameSize.h=_y)}(infoContent=document.createElementNS("http://www.w3.org/2000/svg","g")).setAttribute("id","infocontent"),infoContent.setAttribute("transform","translate(0,"+(gameOffset.y+gameSize.h+cellSize.h/2)+")"),(infoNodeContent=document.createElementNS("http://www.w3.org/2000/svg","text")).setAttribute("id","text"),infoNodeContent.setAttribute("text-anchor","end"),infoNodeContent.setAttribute("x",(gameOffset.x+gameSize.w+cellSize.w/2)/2-2*cellSize.w),infoNodeContent.setAttribute("y",1.8*cellSize.h),infoNodeContent.setAttribute("font-size",25),infoNodeContent.setAttribute("font-family","Verdana"),infoNodeContent.setAttribute("font-weight","bold"),infoContent.appendChild(infoNodeContent),(infoNodeContent=document.createElementNS("http://www.w3.org/2000/svg","g")).setAttribute("id","dices"),infoNodeContent.setAttribute("transform","translate("+(gameOffset.x+gameSize.w+cellSize.w/2)/2+","+2*cellSize.h/3+")"),infoContent.appendChild(infoNodeContent),svgContent.appendChild(infoContent),(playerContent=document.createElementNS("http://www.w3.org/2000/svg","g")).setAttribute("id","playercontent"),svgContent.appendChild(playerContent),content.appendChild(svgContent)}function genHexagonSVG(x,y,w,h,id){var node=document.createElementNS("http://www.w3.org/2000/svg","polygon"),val="";node.data=[],w/=Math.cos(Math.PI/6);for(var i=0;i<6;++i){var angle=Math.PI/3*i+Math.PI/6;i&&(val+=" ");var obj={x:Math.cos(angle)*w/2+x,y:Math.sin(angle)*h/2+y};val+=obj.x+","+obj.y,node.data.push(obj)}return node.setAttribute("points",val),node.setAttribute("id",id),node.setAttribute("_x",x),node.setAttribute("_y",y),node}function setRegionData(id,color,dices){if(!waitLoad(setRegionData,this,arguments)){var stateObj=document.getElementById("state");if(stateObj){var region=currentMap.regions[id];if(region){region.obj.setAttribute("fill",color),region.obj.setAttribute("fill-opacity","0.7");var diceObj=stateObj.querySelector("#dice_"+id);diceObj||((diceObj=document.createElementNS("http://www.w3.org/2000/svg","use")).setAttribute("id","dice_"+id),diceObj.setAttribute("x",region.center.x),diceObj.setAttribute("y",region.center.y),stateObj.appendChild(diceObj)),diceObj.setAttribute("href","#dice"+dices),diceObj.setAttribute("fill",color)}}}}var Players=[];const PlayersColor=["orange","purple","red","green","yellow","lightgreen","pink","lightblue"];function initPlayer(player){!1 in player||(Players[player.id]=player,drawPlayers())}const minPlayerSize=200,minPlayerSpace=cellSize.w;function drawPlayers(){if(!waitLoad(drawPlayers,this,arguments)&&Players&&playerContent){var nb=0;for(var i in Players){var playerContener=document.getElementById("player_"+i),node,subnode;playerContener||((playerContener=document.createElementNS("http://www.w3.org/2000/svg","g")).setAttribute("id","player_"+i),playerContent.appendChild(playerContener),(node=document.createElementNS("http://www.w3.org/2000/svg","rect")).setAttribute("height",4*cellSize.h),node.setAttribute("fill","#CCC"),node.setAttribute("stroke","#999"),node.setAttribute("rx",cellSize.w/3),node.setAttribute("ry",cellSize.w/3),playerContener.appendChild(node),(node=document.createElementNS("http://www.w3.org/2000/svg","text")).textContent="#"+(nb+1),node.setAttribute("font-family","Verdana"),node.setAttribute("x",10),node.setAttribute("y",20),playerContener.appendChild(node),(node=document.createElementNS("http://www.w3.org/2000/svg","g")).setAttribute("transform","translate(30,45)"),(subnode=document.createElementNS("http://www.w3.org/2000/svg","use")).setAttribute("href","#dice"),subnode.setAttribute("transform","scale(0.7,0.7)"),subnode.setAttribute("fill",PlayersColor[i]),node.appendChild(subnode),(subnode=document.createElementNS("http://www.w3.org/2000/svg","text")).setAttribute("id","score"),subnode.textContent="0",subnode.setAttribute("font-size",25),subnode.setAttribute("font-family","Verdana"),subnode.setAttribute("font-weight","bold"),subnode.setAttribute("x",25),subnode.setAttribute("y",14),node.appendChild(subnode),(subnode=document.createElementNS("http://www.w3.org/2000/svg","use")).setAttribute("href","img/treasure.svg#treasure"),subnode.setAttribute("transform","scale(0.35,0.35)"),subnode.setAttribute("x",300),subnode.setAttribute("fill",PlayersColor[i]),node.appendChild(subnode),(subnode=document.createElementNS("http://www.w3.org/2000/svg","text")).setAttribute("id","stock"),subnode.textContent="0",subnode.setAttribute("font-size",25),subnode.setAttribute("font-family","Verdana"),subnode.setAttribute("font-weight","bold"),subnode.setAttribute("x",130),subnode.setAttribute("y",14),node.appendChild(subnode),playerContener.appendChild(node),(node=document.createElementNS("http://www.w3.org/2000/svg","g")).setAttribute("id","player_data"),playerContener.appendChild(node));var _w=gameSize.w+cellSize.w/2,_n,size=(_w-((_n=Players.length)-1)*minPlayerSpace)/_n,_n;if(minPlayerSize>size)size=(_w-((_n=Math.floor((_w+minPlayerSpace)/(minPlayerSize+minPlayerSpace)))-1)*minPlayerSpace)/_n;var _x=gameOffset.x+nb%_n*(size+minPlayerSpace),_y=gameOffset.y+3*cellSize.h+gameSize.h+cellSize.h+Math.floor(nb/_n)*(5*cellSize.h);playerContener.setAttribute("transform","translate("+_x+","+_y+")"),playerContener.querySelector("rect").setAttribute("width",size);var playerData=playerContener.querySelector("#player_data");updatePlayerContent(playerContener,Players[i]),nb++}}}function updatePlayerContent(contener,player){var node;(!contener instanceof SVGElement&&(contener=document.getElementById("player_"+contener)),contener)&&((node=contener.querySelector("#name"))||((node=document.createElementNS("http://www.w3.org/2000/svg","text")).setAttribute("id","name"),node.setAttribute("font-family","Verdana"),node.setAttribute("font-style","italic"),node.setAttribute("font-weight","bold"),node.setAttribute("x","40"),node.setAttribute("y","20"),node.setAttribute("lengthAdjust","spacingAndGlyphs"),contener.appendChild(node)),node.textContent=player.name)}var GameStates=[],CurGameState=0;function setState(gameState){var turn=parseInt(gameState.id);GameStates[turn]=gameState,CurGameState<=turn&&displayState(turn)}var CurrentStateChange=!1,NextStateChange=[];async function displayState(turn,details=!0){if(!waitLoad(displayState,this,arguments)&&(NextStateChange.push({turn:turn,details:details}),!CurrentStateChange)){CurrentStateChange=!0;do{var args=NextStateChange.shift();await _displayState(args.turn,args.details)}while(NextStateChange.length);CurrentStateChange=!1}}async function _displayState(turn,details){if(infoContent){var newGameState=GameStates[turn],oldGameState=turn!=CurGameState?GameStates[CurGameState]:null;if(newGameState){if(details&&newGameState.turn.player){infoContent.querySelector("#text").textContent="Joueur #"+(newGameState.turn.player+1);for(var diceContent=infoContent.querySelector("#dices"),node;node=diceContent.firstChild;)node.remove();for(var offset=0,player=[newGameState.turn.attack.from,newGameState.turn.attack.to],region,p=0;p<2;++p){var score=0,subnode;for(var i in newGameState.turn.dices[p]){var dice=newGameState.turn.dices[p][i],subnode;if(dice>0)score+=dice,(subnode=document.createElementNS("http://www.w3.org/2000/svg","use")).setAttribute("href","dicef"+dice),subnode.setAttribute("transform","translate("+offset+",0) scale(1,1)"),subnode.setAttribute("fill",PlayersColor[oldGameState.map[player[p]].owner]),diceContent.appendChild(subnode),offset+=35}(subnode=document.createElementNS("http://www.w3.org/2000/svg","text")).setAttribute("font-size","18"),subnode.setAttribute("font-family","Verdana"),subnode.setAttribute("font-style","italic"),subnode.setAttribute("transform","translate("+(offset+5)+",20)"),subnode.setAttribute("fill",PlayersColor[oldGameState.map[player[p]].owner]),subnode.textContent=score,diceContent.appendChild(subnode),offset+=60,(region=document.getElementById("region_"+player[p]))&&region.querySelector("#anim").beginElement()}await sleep(1500)}else{infoContent.querySelector("#text").textContent="";for(var diceContent=infoContent.querySelector("#dices"),node;node=diceContent.firstChild;)node.remove()}for(var i in newGameState.stock){var playerContener=document.getElementById("player_"+i);if(playerContener){var scoreObj,stockObj;if(!oldGameState||newGameState.points[i]!=oldGameState.points[i])playerContener.querySelector("#score").textContent=newGameState.points[i];if(!oldGameState||newGameState.stock[i]!=oldGameState.stock[i])playerContener.querySelector("#stock").textContent=newGameState.stock[i]}}for(var i in newGameState.map)oldGameState&&newGameState.map[i].dices==oldGameState.map[i].dices&&newGameState.map[i].owner==oldGameState.map[i].owner||setRegionData(i,PlayersColor[newGameState.map[i].owner],newGameState.map[i].dices);CurGameState=turn}}}function sleep(ms){return new Promise(resolve=>setTimeout(resolve,ms))}